<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Word Counter Pro+</title>
<meta name="description" content="Advanced word counter with PDF, OCR, reading time, voice reader and export.">
<meta name="keywords" content="word counter, character counter, pdf counter, reading time">
<meta name="author" content="Word Counter Pro+">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<link rel="manifest" href="manifest.json">
<style>
:root{--bg:#020617;--card:#020617;--text:#e5e7eb;--border:#1e293b;--btn:#2563eb}
body.light{--bg:#f8fafc;--card:#ffffff;--text:#020617;--border:#cbd5e1;--btn:#2563eb}
*{box-sizing:border-box;font-family:Inter,system-ui}
body{margin:0;background:var(--bg);color:var(--text)}
.container{max-width:1400px;margin:auto;padding:28px}
header{text-align:center;margin-bottom:30px}
header h1{font-size:48px;font-weight:800}
.card{background:var(--card);border-radius:24px;padding:24px;box-shadow:0 30px 70px rgba(0,0,0,.4)}
textarea{width:100%;height:260px;background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:18px;padding:18px;font-size:15px}
.controls{display:flex;flex-wrap:wrap;gap:12px;margin:18px 0}
button,label,select{background:var(--btn);border:none;border-radius:16px;padding:12px 20px;color:white;font-weight:600;cursor:pointer}
button.secondary{background:var(--card);border:1px solid var(--border);color:var(--text)}
input[type=file]{display:none}
select{background:var(--card);border:1px solid var(--border);color:var(--text)}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(190px,1fr));gap:16px}
.stat{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:16px;text-align:center}
.stat h2{margin:0;font-size:28px;font-weight:800}
.stat span{font-size:13px;opacity:.7}
.panel{margin-top:20px;background:var(--card);border:1px solid var(--border);border-radius:18px;padding:16px}
footer{text-align:center;margin-top:36px;opacity:.6;font-size:13px}
</style>
</head>
<body>
<div class="container" id="captureArea">
<header>
<h1>Word Counter Pro+</h1>
<p>All-in-one text analytics with voice, export, PWA & themes</p>
</header>
<div class="card">
<textarea id="textInput" placeholder="Paste or type text here..."></textarea>
<div class="controls">
<button onclick="clearText()">Clear</button>
<label for="fileInput">Upload PDF / Image</label>
<input type="file" id="fileInput" accept=".pdf,.png,.jpg,.jpeg">
<select id="readerSpeed"><option value="150">Slow</option><option value="200" selected>Normal</option><option value="300">Fast</option></select>
<button class="secondary" onclick="exportImage()">Export Screenshot</button>
<button class="secondary" id="speechBtn" onclick="toggleSpeech()">Read Aloud</button>
<button class="secondary" onclick="toggleTheme()">Theme</button>
</div>
<div class="stats">
<div class="stat"><h2 id="words">0</h2><span>Words</span></div>
<div class="stat"><h2 id="sentences">0</h2><span>Sentences</span></div>
<div class="stat"><h2 id="characters">0</h2><span>Characters</span></div>
<div class="stat"><h2 id="charactersNoSpace">0</h2><span>No-space Characters</span></div>
<div class="stat"><h2 id="paragraphs">0</h2><span>Paragraphs</span></div>
<div class="stat"><h2 id="pages">0</h2><span>Estimated Pages</span></div>
<div class="stat"><h2 id="readingTime">0 min</h2><span>Reading Time</span></div>
<div class="stat"><h2 id="pdfPages">0</h2><span>PDF Pages</span></div>
</div>
<div class="panel" id="analysisBox"></div>
</div>
<footer>SEO ready • PWA ready • GitHub Pages</footer>
</div>
<script>
const textInput = document.getElementById('textInput')
const readerSpeed = document.getElementById('readerSpeed')
const speechBtn = document.getElementById('speechBtn')
let uploadedPdfPages = 0
let speaking = false
let currentAudio = null

// ElevenLabs API Configuration - Using the exact format from your working example
const API_KEY = "sk_6a147f065aa760930d817b1c84fcf9fc53374920f6264b6a"
const VOICE_ID = "6FiCmD8eY5VyjOdG5Zjk"

// autosave
textInput.value = localStorage.getItem('savedText') || ''

function detectLang() {
    const t = textInput.value;
    if (/[ğüşöçıİ]/i.test(t)) return 'tr-TR';
    if (/[а-яА-Я]/.test(t)) return 'ru-RU';
    return 'en-US';
}

function updateCounts() {
    const text = textInput.value
    localStorage.setItem('savedText', text)
    const wordsArr = text.trim() ? text.trim().split(/\s+/) : []
    const wordsCount = wordsArr.length
    const sentenceArr = text.split(/[.!?]+/).filter(s => s.trim())
    const sentenceCount = sentenceArr.length
    const charCount = text.length
    const charNoSpace = text.replace(/\s/g, '').length
    const paraCount = text.split(/\n+/).filter(p => p.trim()).length
    const pageCount = wordsCount ? Math.ceil(wordsCount / 250) : 0
    
    // More precise reading time calculation
    const wpm = parseInt(readerSpeed.value)
    const totalSeconds = wordsCount ? (wordsCount / wpm) * 60 : 0
    const minutes = Math.floor(totalSeconds / 60)
    const seconds = Math.floor(totalSeconds % 60)
    
    // Format reading time display
    let readingTimeDisplay = ''
    if (wordsCount === 0) {
        readingTimeDisplay = '0 min'
    } else if (minutes === 0) {
        readingTimeDisplay = seconds + ' sec'
    } else if (seconds === 0) {
        readingTimeDisplay = minutes + ' min'
    } else {
        readingTimeDisplay = minutes + ' min ' + seconds + ' sec'
    }
    
    let longest = ''
    sentenceArr.forEach(s => {
        if (s.length > longest.length) longest = s
    })
    words.textContent = wordsCount
    sentences.textContent = sentenceCount
    characters.textContent = charCount
    charactersNoSpace.textContent = charNoSpace
    paragraphs.textContent = paraCount
    pages.textContent = pageCount
    readingTime.textContent = readingTimeDisplay
    pdfPages.textContent = uploadedPdfPages
    analysisBox.innerHTML = '<b>Longest sentence:</b> ' + (longest || '-')
}

textInput.addEventListener('input', updateCounts)
readerSpeed.addEventListener('change', updateCounts)

function clearText() {
    textInput.value = '';
    uploadedPdfPages = 0;
    updateCounts();
    stopSpeech();
}

async function toggleSpeech() {
    if (speaking) {
        stopSpeech();
        return;
    }
    
    const text = textInput.value.trim();
    if (!text) {
        alert('Please enter some text to read aloud');
        return;
    }
    
    try {
        speaking = true;
        speechBtn.textContent = 'Stop Reading';
        
        // Use the EXACT format from your working example
        const response = await fetch(
            `https://api.elevenlabs.io/v1/text-to-speech/${VOICE_ID}`,
            {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "xi-api-key": API_KEY
                },
                body: JSON.stringify({
                    text: text,
                    model_id: "eleven_multilingual_v2",
                    voice_settings: {
                        stability: 0.5,
                        similarity_boost: 0.7
                    }
                })
            }
        );

        if (!response.ok) {
            throw new Error(`API Error: ${response.status} ${response.statusText}`);
        }

        const audioBlob = await response.blob();
        const audioUrl = URL.createObjectURL(audioBlob);
        
        currentAudio = new Audio(audioUrl);
        currentAudio.play();
        
        currentAudio.onended = () => {
            speaking = false;
            speechBtn.textContent = 'Read Aloud';
            URL.revokeObjectURL(audioUrl);
        };
        
        currentAudio.onerror = (err) => {
            console.error('Audio playback error:', err);
            speaking = false;
            speechBtn.textContent = 'Read Aloud';
            alert('Error playing audio. Please try again.');
            URL.revokeObjectURL(audioUrl);
        };
        
    } catch (error) {
        console.error('Speech generation error:', error);
        speaking = false;
        speechBtn.textContent = 'Read Aloud';
        
        // Fallback to browser speech synthesis
        alert('ElevenLabs API error. Using browser speech synthesis instead.');
        useBrowserSpeechSynthesis(text);
    }
}

function useBrowserSpeechSynthesis(text) {
    if (speaking) {
        speechSynthesis.cancel();
        speaking = false;
        speechBtn.textContent = 'Read Aloud';
        return;
    }
    
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = detectLang();
    
    utterance.onend = () => {
        speaking = false;
        speechBtn.textContent = 'Read Aloud';
    };
    
    utterance.onerror = () => {
        speaking = false;
        speechBtn.textContent = 'Read Aloud';
        alert('Speech synthesis failed. Please try again.');
    };
    
    speechSynthesis.speak(utterance);
    speaking = true;
    speechBtn.textContent = 'Stop Reading';
}

function stopSpeech() {
    if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
        currentAudio = null;
    }
    if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
    }
    speaking = false;
    speechBtn.textContent = 'Read Aloud';
}

function exportImage() {
    html2canvas(document.getElementById('captureArea')).then(canvas => {
        const a = document.createElement('a')
        a.href = canvas.toDataURL('image/png')
        a.download = 'word-counter-stats.png'
        a.click()
    })
}

function toggleTheme() {
    document.body.classList.toggle('light')
}

fileInput.addEventListener('change', async (e) => {
    const file = e.target.files[0]
    if (!file) return
    if (file.type === 'application/pdf') {
        const reader = new FileReader()
        reader.onload = async () => {
            const pdf = await pdfjsLib.getDocument({ data: new Uint8Array(reader.result) }).promise
            uploadedPdfPages = pdf.numPages
            let fullText = ''
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i)
                const content = await page.getTextContent()
                fullText += content.items.map(it => it.str).join(' ') + '\n'
            }
            textInput.value = fullText
            updateCounts()
        }
        reader.readAsArrayBuffer(file)
    } else {
        const result = await Tesseract.recognize(file, 'eng')
        textInput.value = result.data.text
        updateCounts()
    }
})

updateCounts()

// PWA install
let deferredPrompt
window.addEventListener('beforeinstallprompt', e => {
    e.preventDefault();
    deferredPrompt = e;
    setTimeout(() => {
        if (confirm('Install Word Counter Pro+ as app?')) {
            deferredPrompt.prompt()
        }
    }, 2000)
})
</script>
</body>
</html>
